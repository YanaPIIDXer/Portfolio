version: '3'
services:
    # InnerAPI(Rails)
    inner_api:
        build:
            context: ./InnerAPI
        command: rails s -p 3000 -b "0.0.0.0"
        volumes:
            - ./InnerAPI:/app
            - ./DataStore/InnerAPI/BundleInstall:/app/vendor/bundle
            - ./DataStore/InnerAPI/Bundle:/app/.bundle
        ports:
            - "3000:3000"
        environment:
            DATABASE_HOST: db
            # HACK:developだと権限が設定できておらず、止む無くrootで入ってる。
            #      コンソールから入り込んで権限振ったら解決するだろうが・・・
            DATABASE_USERNAME: root
            DATABASE_PASSWORD: root
            DATABASE_NAME: slot_sns
        depends_on:
            - db

    # Database(MySQL)
    db:
        image: mysql:5.7
        command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --innodb-use-native-aio=0
        ports:
            - "3306:3306"
        volumes:
            - ./DataStore/MySQL/data:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_USER: develop
            MYSQL_PASSWORD: develop
            TZ: Asia/Tokyo

    # Redmine
    redmine:
        image: redmine
        ports:
            - 4000:3000
        volumes:
            - ./Redmine/Plugins:/usr/src/redmine/plugins
            - ./Redmine/Themes:/usr/src/redmine/themes
        environment:
            REDMINE_DB_MYSQL: redmine_db
            REDMINE_DB_PASSWORD: redmine
        depends_on:
            - redmine_db

    # Redmine DB
    redmine_db:
        image: mysql:5.7
        command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --explicit_defaults_for_timestamp --innodb-use-native-aio=0
        ports:
            - "3307:3306"
        environment:
            MYSQL_ROOT_PASSWORD: redmine
            MYSQL_DATABASE: redmine
            TZ: Asia/Tokyo
        volumes:
            - ./Redmine/DB:/var/lib/mysql
